<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>解密 angular 双向绑定 · ShaofeiZi Blog · 做个日常记录</title>
    <meta name="description" content="訾绍飞的博客。万物皆有裂缝处，那是光射进来的地方。">
    <link rel="shortcut icon" href="/BLOG/favicon.ico">
  <link rel="manifest" href="/BLOG/manifest.json">
  <meta name="theme-color" content="#3F51B5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/BLOG/icons/192.png">
  <link rel="mask-icon" href="/BLOG/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/192.png">
  <meta name="msapplication-TileColor" content="#3F51B5">
    
    <link rel="preload" href="/BLOG/assets/css/styles.0f06c689.css" as="style"><link rel="preload" href="/BLOG/assets/js/app.0f06c689.js" as="script"><link rel="preload" href="/BLOG/assets/js/14.eb804906.js" as="script"><link rel="prefetch" href="/BLOG/assets/js/1.63593f8f.js"><link rel="prefetch" href="/BLOG/assets/js/10.fdd39873.js"><link rel="prefetch" href="/BLOG/assets/js/11.8a622b5e.js"><link rel="prefetch" href="/BLOG/assets/js/12.e9c56306.js"><link rel="prefetch" href="/BLOG/assets/js/13.20e44605.js"><link rel="prefetch" href="/BLOG/assets/js/15.47582e90.js"><link rel="prefetch" href="/BLOG/assets/js/16.0861cf41.js"><link rel="prefetch" href="/BLOG/assets/js/17.417e8e0e.js"><link rel="prefetch" href="/BLOG/assets/js/18.2318cd37.js"><link rel="prefetch" href="/BLOG/assets/js/19.997f9e1c.js"><link rel="prefetch" href="/BLOG/assets/js/2.73ec8147.js"><link rel="prefetch" href="/BLOG/assets/js/20.a8cf0c8f.js"><link rel="prefetch" href="/BLOG/assets/js/21.88823ca0.js"><link rel="prefetch" href="/BLOG/assets/js/22.a2e20a79.js"><link rel="prefetch" href="/BLOG/assets/js/23.e7d1e135.js"><link rel="prefetch" href="/BLOG/assets/js/24.492e8390.js"><link rel="prefetch" href="/BLOG/assets/js/25.b31904c7.js"><link rel="prefetch" href="/BLOG/assets/js/26.36e1cf84.js"><link rel="prefetch" href="/BLOG/assets/js/27.94b05a58.js"><link rel="prefetch" href="/BLOG/assets/js/28.bdcf9b24.js"><link rel="prefetch" href="/BLOG/assets/js/29.e41d34d2.js"><link rel="prefetch" href="/BLOG/assets/js/3.a4d6da98.js"><link rel="prefetch" href="/BLOG/assets/js/30.ba1f5d39.js"><link rel="prefetch" href="/BLOG/assets/js/31.2bd2d3d8.js"><link rel="prefetch" href="/BLOG/assets/js/32.824499f7.js"><link rel="prefetch" href="/BLOG/assets/js/33.58645df0.js"><link rel="prefetch" href="/BLOG/assets/js/34.334e4a83.js"><link rel="prefetch" href="/BLOG/assets/js/35.aa96d72d.js"><link rel="prefetch" href="/BLOG/assets/js/36.40c509d3.js"><link rel="prefetch" href="/BLOG/assets/js/37.829377f5.js"><link rel="prefetch" href="/BLOG/assets/js/38.3b15ddc7.js"><link rel="prefetch" href="/BLOG/assets/js/39.87218167.js"><link rel="prefetch" href="/BLOG/assets/js/4.c66c6308.js"><link rel="prefetch" href="/BLOG/assets/js/40.63562db5.js"><link rel="prefetch" href="/BLOG/assets/js/41.168fcabb.js"><link rel="prefetch" href="/BLOG/assets/js/42.e8f3ecd2.js"><link rel="prefetch" href="/BLOG/assets/js/43.5eb65461.js"><link rel="prefetch" href="/BLOG/assets/js/44.41e08b42.js"><link rel="prefetch" href="/BLOG/assets/js/45.54b7df8d.js"><link rel="prefetch" href="/BLOG/assets/js/46.0a0de71e.js"><link rel="prefetch" href="/BLOG/assets/js/47.bd587f67.js"><link rel="prefetch" href="/BLOG/assets/js/48.f3af8d7e.js"><link rel="prefetch" href="/BLOG/assets/js/49.483980fa.js"><link rel="prefetch" href="/BLOG/assets/js/5.05c034ec.js"><link rel="prefetch" href="/BLOG/assets/js/50.f814132b.js"><link rel="prefetch" href="/BLOG/assets/js/51.477c87bb.js"><link rel="prefetch" href="/BLOG/assets/js/52.55f963c5.js"><link rel="prefetch" href="/BLOG/assets/js/53.9eafd57f.js"><link rel="prefetch" href="/BLOG/assets/js/54.be1ba528.js"><link rel="prefetch" href="/BLOG/assets/js/55.a0ef8049.js"><link rel="prefetch" href="/BLOG/assets/js/56.8e8dca35.js"><link rel="prefetch" href="/BLOG/assets/js/6.f61c2d7b.js"><link rel="prefetch" href="/BLOG/assets/js/7.acadab6a.js"><link rel="prefetch" href="/BLOG/assets/js/8.8d991ea8.js"><link rel="prefetch" href="/BLOG/assets/js/9.efa09c0d.js">
    <link rel="stylesheet" href="/BLOG/assets/css/styles.0f06c689.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="application theme--light"><div class="application--wrap"><div role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="v-progress-linear blog-progress" style="height:3px;display:none;"><div class="v-progress-linear__background accent" style="height:3px;opacity:0.4;width:100%;"></div><div class="v-progress-linear__bar"><!----><div class="v-progress-linear__bar__determinate accent" style="width:0%;"></div></div></div><aside class="v-navigation-drawer v-navigation-drawer--close v-navigation-drawer--fixed v-navigation-drawer--is-mobile theme--light" style="height:100%;margin-top:0px;transform:translateX(-240px);width:240px;"><div><div class="aside-brand-wrap"><div class="aside-brand"><a href="/BLOG/" class="aside-avatar elevation-2 router-link-active"><img src="/BLOG/face.png" alt="avatar"></a><hgroup class="mt-3 variant-hide"><div class="subheading white--text">訾绍飞</div><a href="mailto:zishaofei221@gmail.com" title="zishaofei221@gmail.com" class="aside-mail primary--text text--lighten-5">zishaofei221@gmail.com</a></hgroup></div></div><hr class="v-divider theme--dark"><div role="list" class="v-list nav-list theme--light"><div role="listitem"><a href="/BLOG/" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fa fa-home"></i></div></div><div class="v-list__tile__content">首页</div></a></div><div role="listitem"><a href="/BLOG/tags" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fa fa-tag"></i></div></div><div class="v-list__tile__content">标签</div></a></div><div role="listitem"><a href="https://github.com/ShaofeiZi" target="_blank" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fab fa-github"></i></div></div><div class="v-list__tile__content">Github</div></a></div><div role="listitem"><a href="/BLOG/about" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fa fa-user-secret"></i></div></div><div class="v-list__tile__content">About</div></a></div></div></div><div class="v-navigation-drawer__border"></div></aside><nav class="blog-toolbar v-toolbar v-toolbar--fixed theme--dark primary" style="margin-top:0px;padding-right:0px;padding-left:0px;transform:translateY(0px);"><div class="v-toolbar__content" style="height:56px;"><button type="button" class="v-btn v-btn--icon theme--dark"><div class="v-btn__content"><i class="fa fa-bars"></i></div></button><div class="v-toolbar__title">解密 angular 双向绑定</div><div class="spacer"></div><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><div class="v-menu v-menu--inline" style="display:none;"><div class="v-menu__activator"><button type="button" class="v-btn v-btn--icon theme--dark"><div class="v-btn__content"><i class="fa fa-share-alt"></i></div></button></div><div class="v-menu__content theme--light " style="max-height:auto;min-width:0px;max-width:auto;top:12px;left:0px;transform-origin:top right;z-index:0;display:none;"><div role="list" class="v-list theme--light"><div role="listitem"><a class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fa fa-lg fa-copy"></i></div></div><div class="v-list__tile__title">复制链接</div></a></div></div><input type="text" tabindex="-1" aria-hidden="true" value="" class="fake-hide"></div></div></div></nav><main class="v-content" style="padding-top:56px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-content__wrap"><div class="container blog-container grid-list-xl align-center"><div class="layout row wrap"><div class="flex mb-3 xs12"><article class="v-card v-sheet theme--light elevation-16 post-card"><div class="v-card__title"><div class="flex xs12"><h2 class="display-1 mb-3">解密 angular 双向绑定</h2><div class="post-meta"><time datetime="2018-07-08T22:15:53.000Z" class="secondary--text post-time">2018年07月09日</time></div></div></div><div class="v-card__text pt-0 pb-0"><div class="flex xs12"><div class="content custom"><p>Angular 的双向绑定与 AngularJS 的双向绑定工作原理是完全不同的，目前看起来是没有 AngularJS 会遇到性能问题。那 Angular 的双向绑定到底是怎么工作的呢?</p><h2 id="如何使用-双向绑定-two-way-binding"><a href="#如何使用-双向绑定-two-way-binding" aria-hidden="true" class="header-anchor">#</a> 如何使用 双向绑定 (Two-way Binding)</h2><p>以下的三种写法都可以达到双向绑定的效果</p><h3 id="方法1"><a href="#方法1" aria-hidden="true" class="header-anchor">#</a> 方法1</h3><p>使用 <code>[()]</code> 的写法</p><pre class="language-typescript"><code><span class="token operator">&lt;</span>input <span class="token punctuation">[</span><span class="token punctuation">(</span>ngModel<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;username&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Hello <span class="token punctuation">{</span><span class="token punctuation">{</span>username<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
</code></pre><h3 id="方法2"><a href="#方法2" aria-hidden="true" class="header-anchor">#</a> 方法2</h3><p>将 <code>[]</code><code>()</code> 分开写</p><pre class="language-typescript"><code><span class="token operator">&lt;</span>input <span class="token punctuation">[</span>ngModel<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;username&quot;</span> <span class="token punctuation">(</span>ngModelChange<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;username = $event&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Hello <span class="token punctuation">{</span><span class="token punctuation">{</span>username<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
</code></pre><h3 id="方法3"><a href="#方法3" aria-hidden="true" class="header-anchor">#</a> 方法3</h3><p>不使用 ngModel</p><pre class="language-typescript"><code><span class="token operator">&lt;</span>input <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;username&quot;</span> <span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;username = $event.target.value&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Hello <span class="token punctuation">{</span><span class="token punctuation">{</span>username<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
</code></pre><h2 id="的秘密"><a href="#的秘密" aria-hidden="true" class="header-anchor">#</a> [()] 的秘密</h2><p>我们知道 <code>[()]</code> 是 Angular 所提供给双向绑定的语法糖，但是底层到底是怎么工作的，为什么会可以转换成 <code>[&lt;name&gt;]</code> +<code>(&lt;name&gt;Change)</code> 呢? 以下简单说明</p><ul><li><code>compiler/src/template_parser/template_parser.ts</code> 里面会去分析 Element 的 attribute 是否有符合各种格式的内容</li></ul><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token constant">BIND_NAME_REGEXP</span> <span class="token operator">=</span>
    <span class="token regex">/^(?:(?:(?:(bind-)|(let-)|(ref-|#)|(on-)|(bindon-)|(@))(.+))|\[\(([^\)]+)\)\]|\[([^\]]+)\]|\(([^\)]+)\))$/</span><span class="token punctuation">;</span>

<span class="token comment">// Group 1 = &quot;bind-&quot;</span>
<span class="token keyword">const</span> <span class="token constant">KW_BIND_IDX</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// Group 2 = &quot;let-&quot;</span>
<span class="token keyword">const</span> <span class="token constant">KW_LET_IDX</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">// Group 3 = &quot;ref-/#&quot;</span>
<span class="token keyword">const</span> <span class="token constant">KW_REF_IDX</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">// Group 4 = &quot;on-&quot;</span>
<span class="token keyword">const</span> <span class="token constant">KW_ON_IDX</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token comment">// Group 5 = &quot;bindon-&quot;</span>
<span class="token keyword">const</span> <span class="token constant">KW_BINDON_IDX</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">// Group 6 = &quot;@&quot;</span>
<span class="token keyword">const</span> <span class="token constant">KW_AT_IDX</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token comment">// Group 7 = the identifier after &quot;bind-&quot;, &quot;let-&quot;, &quot;ref-/#&quot;, &quot;on-&quot;, &quot;bindon-&quot; or &quot;@&quot;</span>
<span class="token keyword">const</span> <span class="token constant">IDENT_KW_IDX</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token comment">// Group 8 = identifier inside [()]</span>
<span class="highlighted-line"><span class="token keyword">const</span> <span class="token constant">IDENT_BANANA_BOX_IDX</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></span><span class="token comment">// Group 9 = identifier inside []</span>
<span class="token keyword">const</span> <span class="token constant">IDENT_PROPERTY_IDX</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token comment">// Group 10 = identifier inside ()</span>
<span class="token keyword">const</span> <span class="token constant">IDENT_EVENT_IDX</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre><pre class="language-typescript"><code> <span class="token keyword">private</span> <span class="token function">_parseAttr</span><span class="token punctuation">(</span>
      isTemplateElement<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> attr<span class="token operator">:</span> html<span class="token punctuation">.</span>Attribute<span class="token punctuation">,</span> targetMatchableAttrs<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      targetProps<span class="token operator">:</span> ParsedProperty<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> targetEvents<span class="token operator">:</span> t<span class="token punctuation">.</span>BoundEventAst<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      targetRefs<span class="token operator">:</span> ElementOrDirectiveRef<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> targetVars<span class="token operator">:</span> t<span class="token punctuation">.</span>VariableAst<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_normalizeAttributeName</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> attr<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">const</span> srcSpan <span class="token operator">=</span> attr<span class="token punctuation">.</span>sourceSpan<span class="token punctuation">;</span>

    <span class="token keyword">const</span> boundEvents<span class="token operator">:</span> ParsedEvent<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> bindParts <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token constant">BIND_NAME_REGEXP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> hasBinding <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hasBinding <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">KW_BIND_IDX</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parsePropertyBinding</span><span class="token punctuation">(</span>
            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_KW_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> targetProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">KW_LET_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isTemplateElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> identifier <span class="token operator">=</span> bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_KW_IDX</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseVariable</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetVars<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_reportError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;let-&quot; is only supported on ng-template elements.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> srcSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">KW_REF_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> identifier <span class="token operator">=</span> bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_KW_IDX</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseReference</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">KW_ON_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parseEvent</span><span class="token punctuation">(</span>
            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_KW_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> boundEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">KW_BINDON_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parsePropertyBinding</span><span class="token punctuation">(</span>
            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_KW_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> targetProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseAssignmentEvent</span><span class="token punctuation">(</span>
            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_KW_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> boundEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">KW_AT_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parseLiteralAttr</span><span class="token punctuation">(</span>
            name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> targetProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_BANANA_BOX_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="highlighted-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parsePropertyBinding</span><span class="token punctuation">(</span></span>            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_BANANA_BOX_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span>
            targetProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseAssignmentEvent</span><span class="token punctuation">(</span>
            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_BANANA_BOX_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> boundEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_PROPERTY_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parsePropertyBinding</span><span class="token punctuation">(</span>
            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_PROPERTY_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span>
            targetProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_EVENT_IDX</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parseEvent</span><span class="token punctuation">(</span>
            bindParts<span class="token punctuation">[</span><span class="token constant">IDENT_EVENT_IDX</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> boundEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      hasBinding <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parsePropertyInterpolation</span><span class="token punctuation">(</span>
          name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> targetProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parseLiteralAttr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> srcSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> targetProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    targetEvents<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>boundEvents<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>BoundEventAst<span class="token punctuation">.</span><span class="token function">fromParsedEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> hasBinding<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><ul><li>根据 <code>_parseAssigmentEvent</code> 就会将部分<code>[(ngModel)]=&quot;username&quot;</code> 转换成 <code>(ngModelChange)=&quot;username = $event&quot;</code> 传入 <code>bindingParser.parseEvent</code> 的方法内</li></ul><pre class="language-typescript"><code>
 <span class="token keyword">private</span> <span class="token function">_parseAssignmentEvent</span><span class="token punctuation">(</span>
     <span class="token parameter">name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> expression<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> sourceSpan<span class="token operator">:</span> ParseSourceSpan<span class="token punctuation">,</span>
     targetMatchableAttrs<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> targetEvents<span class="token operator">:</span> ParsedEvent<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>_bindingParser<span class="token punctuation">.</span><span class="token function">parseEvent</span><span class="token punctuation">(</span>
       <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">Change</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=$event</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> sourceSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> targetEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><ul><li><code>this._bindingParse.parseEvent</code>，会更新 Element 的属性值
路径在
<code>compiler/src/template_parser/binding_parser.ts</code></li></ul><pre class="language-typescript"><code><span class="token function">parseEvent</span><span class="token punctuation">(</span>
     <span class="token parameter">name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> expression<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> sourceSpan<span class="token operator">:</span> ParseSourceSpan<span class="token punctuation">,</span>
     targetMatchableAttrs<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> targetEvents<span class="token operator">:</span> ParsedEvent<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAnimationLabel</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseAnimationEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> expression<span class="token punctuation">,</span> sourceSpan<span class="token punctuation">,</span> targetEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseRegularEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> expression<span class="token punctuation">,</span> sourceSpan<span class="token punctuation">,</span> targetMatchableAttrs<span class="token punctuation">,</span> targetEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><ul><li>这就是 <code>[()]</code> 语法糖的工作方式</li></ul><h2 id="ngmodel"><a href="#ngmodel" aria-hidden="true" class="header-anchor">#</a> ngModel</h2><p><code>ngModel</code> 是 Angular 所提供的 Directive，主要用途是用来简化双向绑定的写法，代码可以<a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/ng_model.ts" target="_blank" rel="noopener noreferrer">看这里</a></p><h3 id="代码说明"><a href="#代码说明" aria-hidden="true" class="header-anchor">#</a> 代码说明</h3><ul><li>ngOnChanges
第一次 Input Change 时，注册 Control 等相关事件，注册流程如下</li></ul><ol><li>检查是否有注册过，如果没有，执行 <code>_setUpControl</code> 的方法，<code>setUpControl</code>是在 <code>forms/src/directives/shared.ts</code> 内实现的，主要功能是 <code>Control</code> 的事件注册。</li></ol><pre class="language-typescript"><code><span class="token function">ngOnChanges</span><span class="token punctuation">(</span><span class="token parameter">changes<span class="token operator">:</span> SimpleChanges</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_checkForErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_registered<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setUpControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'isDisabled'</span> <span class="token keyword">in</span> changes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateDisabled</span><span class="token punctuation">(</span>changes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPropertyUpdated</span><span class="token punctuation">(</span>changes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>viewModel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewModel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token keyword">private</span> <span class="token function">_setUpControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setUpStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>formDirective<span class="token punctuation">.</span><span class="token function">addControl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">_isStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>standalone<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">_setUpStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token function">setUpControl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_control<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>_control<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>emitEvent<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ul><li><code>setUpControl</code> 内有许多事件注册行为，而跟双向绑定有关的事件是 <code>dir.valueAccessor!.registerOnChange</code>，这里会传入一个回调函数</li></ul><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setUpControl</span><span class="token punctuation">(</span><span class="token parameter">control<span class="token operator">:</span> FormControl<span class="token punctuation">,</span> dir<span class="token operator">:</span> NgControl</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>control<span class="token punctuation">)</span> <span class="token function">_throwError</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'Cannot find control with'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">)</span> <span class="token function">_throwError</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'No value accessor for form control with'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  control<span class="token punctuation">.</span>validator <span class="token operator">=</span> Validators<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span><span class="token punctuation">[</span>control<span class="token punctuation">.</span>validator <span class="token operator">!</span><span class="token punctuation">,</span> dir<span class="token punctuation">.</span>validator<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  control<span class="token punctuation">.</span>asyncValidator <span class="token operator">=</span> Validators<span class="token punctuation">.</span><span class="token function">composeAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span>control<span class="token punctuation">.</span>asyncValidator <span class="token operator">!</span><span class="token punctuation">,</span> dir<span class="token punctuation">.</span>asyncValidator<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dir<span class="token punctuation">.</span>valueAccessor <span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>control<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setUpViewChangePipeline</span><span class="token punctuation">(</span>control<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setUpModelChangePipeline</span><span class="token punctuation">(</span>control<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="highlighted-line">  <span class="token function">setUpBlurPipeline</span><span class="token punctuation">(</span>control<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>valueAccessor <span class="token operator">!</span><span class="token punctuation">.</span>setDisabledState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    control<span class="token punctuation">.</span><span class="token function">registerOnDisabledChange</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">isDisabled<span class="token operator">:</span> <span class="token builtin">boolean</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> dir<span class="token punctuation">.</span>valueAccessor <span class="token operator">!</span><span class="token punctuation">.</span>setDisabledState <span class="token operator">!</span><span class="token punctuation">(</span>isDisabled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// re-run validation when validator binding changes, e.g. minlength=3 -&gt; minlength=4</span>
  dir<span class="token punctuation">.</span>_rawValidators<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">validator<span class="token operator">:</span> Validator <span class="token operator">|</span> ValidatorFn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span>registerOnValidatorChange<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span>registerOnValidatorChange <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> control<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  dir<span class="token punctuation">.</span>_rawAsyncValidators<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">validator<span class="token operator">:</span> AsyncValidator <span class="token operator">|</span> AsyncValidatorFn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span>registerOnValidatorChange<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span>registerOnValidatorChange <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> control<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">setUpViewChangePipeline</span><span class="token punctuation">(</span><span class="token parameter">control<span class="token operator">:</span> FormControl<span class="token punctuation">,</span> dir<span class="token operator">:</span> NgControl</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  dir<span class="token punctuation">.</span>valueAccessor <span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">registerOnChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newValue<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    control<span class="token punctuation">.</span>_pendingValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
    control<span class="token punctuation">.</span>_pendingChange <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    control<span class="token punctuation">.</span>_pendingDirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 触发更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>control<span class="token punctuation">.</span>updateOn <span class="token operator">===</span> <span class="token string">'change'</span><span class="token punctuation">)</span> <span class="token function">updateControl</span><span class="token punctuation">(</span>control<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateControl</span><span class="token punctuation">(</span><span class="token parameter">control<span class="token operator">:</span> FormControl<span class="token punctuation">,</span> dir<span class="token operator">:</span> NgControl</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  dir<span class="token punctuation">.</span><span class="token function">viewToModelUpdate</span><span class="token punctuation">(</span>control<span class="token punctuation">.</span>_pendingValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>control<span class="token punctuation">.</span>_pendingDirty<span class="token punctuation">)</span> control<span class="token punctuation">.</span><span class="token function">markAsDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  control<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>control<span class="token punctuation">.</span>_pendingValue<span class="token punctuation">,</span> <span class="token punctuation">{</span>emitModelToViewChange<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ul><li>而当 Input 栏位有资料输入时，就会触发事件并将回传值发送到到页面上
<code>ng_model.ts</code></li></ul><pre class="language-typescript"><code><span class="token function">viewToModelUpdate</span><span class="token punctuation">(</span>newValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>viewModel <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>update<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ng-value-accessor"><a href="#ng-value-accessor" aria-hidden="true" class="header-anchor">#</a> NG_VALUE_ACCESSOR</h3><p>这个 provider 是让 <code>ngModleChange</code> 接受 <code>$event</code> 而不是 <code>$event.target.value</code> 的
<img src="/images/angularTwoWayBinding.png" alt></p><p>在各类型的 <code>Control</code> 都会有一份 <code>NG_VALUE_ACCESSOR</code> ，而针对 <code>ngModel</code> 我们需留意的是 <code>DEFAULT_VALUE_ACCESSOR</code> ，代码在 <code>default_value_accessor.ts</code></p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>使用 multi 的 DI 方式并不是这篇文章的重点，只要知道这样子写，可以让 Provider 使用同一个名称但又可同时存在不互相影响</p></div><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DEFAULT_VALUE_ACCESSOR</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token constant">NG_VALUE_ACCESSOR</span><span class="token punctuation">,</span>
  useExisting<span class="token operator">:</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DefaultValueAccessor<span class="token punctuation">)</span><span class="token punctuation">,</span>
  multi<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><pre class="language-typescript"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span>
      <span class="token string">'input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]'</span><span class="token punctuation">,</span>
  host<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'(input)'</span><span class="token operator">:</span> <span class="token string">'_handleInput($event.target.value)'</span><span class="token punctuation">,</span>
    <span class="token string">'(blur)'</span><span class="token operator">:</span> <span class="token string">'onTouched()'</span><span class="token punctuation">,</span>
    <span class="token string">'(compositionstart)'</span><span class="token operator">:</span> <span class="token string">'_compositionStart()'</span><span class="token punctuation">,</span>
    <span class="token string">'(compositionend)'</span><span class="token operator">:</span> <span class="token string">'_compositionEnd($event.target.value)'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">DEFAULT_VALUE_ACCESSOR</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DefaultValueAccessor</span> <span class="token keyword">implements</span> <span class="token class-name">ControlValueAccessor</span> <span class="token punctuation">{</span>  
  <span class="token function-variable function">onChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function-variable function">onTouched</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/** Whether the user is creating a composition string (IME events). */</span>
  <span class="token keyword">private</span> _composing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
      <span class="token parameter"><span class="token keyword">private</span> _renderer<span class="token operator">:</span> Renderer<span class="token punctuation">,</span> <span class="token keyword">private</span> _elementRef<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span>
      @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">COMPOSITION_BUFFER_MODE</span><span class="token punctuation">)</span> <span class="token keyword">private</span> _compositionMode<span class="token operator">:</span> <span class="token builtin">boolean</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">_isAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">writeValue</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> normalizedValue <span class="token operator">=</span> value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer<span class="token punctuation">.</span><span class="token function">setElementProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_elementRef<span class="token punctuation">.</span>nativeElement<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> normalizedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">registerOnChange</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onChange <span class="token operator">=</span> fn<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token function">registerOnTouched</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onTouched <span class="token operator">=</span> fn<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token operator">...</span>

  <span class="token function">_handleInput</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_composing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><p><code>DefaultValueAccessor</code> 里 <code>registerOnChange</code> 与 <code>onChange</code> 的关系是，<code>ngModel</code> 会经 <code>setUpControl</code> 的方法将自订方法通过 <code>registerOnChange</code> 注册到 <code>onChange</code> 上，</p><p><code>DefaultValueAccessor</code> 的 <code>@Directive</code> 的地方，有注册 <code>(input)</code> 事件发生时会触发的方法， <code>_handleInput($event.target.value)</code></p><pre class="language-typescript"><code><span class="token function">_handleInput</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_composing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>经过这一串的折腾，魔法就出现了，<code>ngModle</code> 的 <code>@Output('ngModelChange')</code> 会收到并发送资料到页面上，这也就是为什么 <code>(ngModelChange)</code> 的 <code>$event</code> 不需要加上 target.value，又可以取得数据</p><h2 id="划重点"><a href="#划重点" aria-hidden="true" class="header-anchor">#</a> 划重点</h2><p>以下是双向绑定相关的流程顺序</p><ol><li><code>[ngModel]</code>时会触发 <code>ngOnChanges</code> 事件</li><li>在 <code>ngOnChanges</code> 时，会执行 <code>setUpControl()</code> 方法</li><li>在 <code>setupControl()</code> 内会注册 <code>DefaultValueAccess</code> 执行 <code>registerOnChange</code>，并将 callback function 传入</li><li>通过 <code>registerOnChanges</code> 传入的 callback function 会被绑定到 <code>onChanges</code> 上</li><li>当 <code>(input)</code> 事件被触发时，会执行 <code>_handleInput($event.target.value)</code> 的方法</li><li>将传入 <code>_handleInput(value)</code> 的值传给注册在 <code>onChange</code> 的 callback function</li><li>callback function 会执行 <code>ngModel</code> 里的 <code>viewToModelUpdate(newValue)</code> 方法</li><li>最后将 <code>viewToModelUpdate</code> 所接受到的值，透过 <code>ngModelChange</code> 的 EventEmiiter emit 传到页面上</li><li>完成整个双向绑定的动作</li></ol></div></div></div><div class="v-card__actions"><div class="flex xs12"><a href="/BLOG/tags/angular"><span tabindex="0" class="v-chip capitalize chip-tag v-chip--label v-chip--small theme--light"><span class="v-chip__content">angular</span></span></a><a href="/BLOG/tags/双向绑定"><span tabindex="0" class="v-chip capitalize chip-tag v-chip--label v-chip--small theme--light"><span class="v-chip__content">双向绑定</span></span></a></div></div></article></div><div class="flex text-xs-left xs6"><a href="/BLOG/posts/ast.html" class="post-nav v-btn v-btn--flat v-btn--router theme--light"><div class="v-btn__content"><div class="grey--text"><i class="fa mr-1 fa-chevron-left"></i>Prev</div><div class="title mt-1 primary--text hidden-xs-only">抽象语法树(Abstract Syntax Tree)</div></div></a></div><div class="flex text-xs-right xs6"><a href="/BLOG/posts/rxjs-spy_rxjsDebugger.html" class="post-nav v-btn v-btn--flat v-btn--router theme--light"><div class="v-btn__content"><div class="grey--text">Next
          <i class="fa ml-1 fa-chevron-right"></i></div><div class="title mt-1 primary--text hidden-xs-only">rxjs-spy：RxJS Debugger 神器</div></div></a></div><div class="flex mt-3 xs12"><div class="v-card v-sheet theme--light"><div class="v-card__title"><span class="headline">Comment</span></div></div></div></div></div><footer class="v-footer blog-footer darken-1 mt-3 theme--dark" style="height:auto;"><div class="primary--text text--lighten-4 text-xs-center py-3 card-cont v-card v-card--flat v-sheet v-sheet--tile theme--dark primary"><div class="v-card__text pb-0">博客内容遵循 <a rel="license noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></div><div class="v-card__text pt-0 mt-1"><span>訾绍飞 © 2015 - 2020</span><span><!---->
        Power by
        <a href="https://vuepress.vuejs.org" target="_blank" rel="noopener noreferrer">VuePress</a> Theme
        <a href="https://github.com/ShaofeiZi/BLOG" target="_blank" rel="noopener noreferrer">indigo</a></span></div></div></footer></div></main><button type="button" class="v-btn v-btn--bottom v-btn--floating v-btn--fixed v-btn--right theme--light accent" style="display:none;"><div class="v-btn__content"><i class="fa fa-lg fa-chevron-up"></i></div></button></div></div></div>
    <script src="/BLOG/assets/js/app.0f06c689.js" defer></script><script src="/BLOG/assets/js/14.eb804906.js" defer></script>
  </body>
</html>
