(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{225:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this.$createElement;this._self._c;return this._m(0)}),[function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"node的模块化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node的模块化","aria-hidden":"true"}},[t._v("#")]),t._v(" node的模块化")]),a("p",[t._v("首先 假设 大家对 AMD CMD CommonJs 模块都有一定的了解 、\n然后 我再说一下node用的CommonJs\nnodeJS的根基就是ES  ES6之前 本身是没有模块机制的\n所以出现了 CommonJs\n")]),a("h2",{attrs:{id:"commonjs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commonjs","aria-hidden":"true"}},[t._v("#")]),t._v(" CommonJs")]),a("p",[t._v("CommonJs 主要遵循三个约定")]),a("ul",[a("li",[t._v("require")]),a("li",[t._v("模块上下文")]),a("li",[t._v("模块标志\n其他都是 次要的")])]),a("h3",{attrs:{id:"require"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#require","aria-hidden":"true"}},[t._v("#")]),t._v(" require")]),a("p",[t._v("require本身就是一个函数 带一个参数  参数其实就是模块名（严谨点叫模块标志）返回值 是模块暴露的API\n举个例子")]),a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" blahblah "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"boom_shakalaka"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("p",[t._v("这样就能引用到这个模块中的暴露的东东")]),a("h3",{attrs:{id:"模块上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模块上下文","aria-hidden":"true"}},[t._v("#")]),t._v(" 模块上下文")]),a("p",[t._v("在一个CommonJs的上下文中需要满足下面这些条件有这些条件存在")]),a("ul",[a("li",[t._v("require")]),a("li",[t._v("exports  （连接异界的神魔之井）")]),a("li",[t._v("module （挂着自带的属性  比如 ID exports）\nmodule.exports的初始对象指向exports")])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("module.exports=XXXXXX\n")])]),a("p",[t._v("然后module.exports就不等于exports了\n"),a("img",{attrs:{src:"/images/nodeModels/_1533119230_1606572170.png",alt:""}}),t._v("\n三者 和外部模块的关系")]),a("h3",{attrs:{id:"模块标志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模块标志","aria-hidden":"true"}},[t._v("#")]),t._v(" 模块标志")]),a("p",[t._v("通俗的讲  就是个模块名"),a("br"),t._v('\n模块标识其实就是一个字符串，用于传给 require 函数的。\n它需要是小驼峰格式的标识名，或者以 "." 以及 ".." 带头的相对路径。理论上来说不应该带上后缀名，如 ".js"。')]),a("p",[t._v("(官网说)[www.commonjs.org]")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('Module Identifiers\nA module identifier is a String of "terms" delimited by forward slashes.\nA term must be a camelCase identifier, ".", or "..".\nModule identifiers may not have file-name extensions like ".js".\nModule identifiers may be "relative" or "top-level". A module identifier is "relative" if the first term is "." or "..".\nTop-level identifiers are resolved off the conceptual module name space root.\nRelative identifiers are resolved relative to the identifier of the module in which "require" is written and called.\n')])]),a("p",[t._v("实际在用的时候 好多人都不遵循规范\n比如好多-cli。。。但是不符合标志啊")]),a("p",[t._v("满足上面三个约定的 基本就可以认为是一个模块"),a("br"),t._v("\n还有两个隐藏约定\n不遵守 也可以ok 比如自己写的时候")]),a("ul",[a("li",[t._v("存储方案；")]),a("li",[t._v("加载器可以支持环境变量寻径，也可以不支持。")])]),a("h3",{attrs:{id:"存储方案；"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储方案；","aria-hidden":"true"}},[t._v("#")]),t._v(" 存储方案；")]),a("p",[t._v("模块内容存在数据库 文件 函数 链接库  都OK  比如node 就直接放文件系统   node_modules"),a("br"),t._v("\nC++模块是用动态链接的  跳过")]),a("h3",{attrs:{id:"加载器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加载器","aria-hidden":"true"}},[t._v("#")]),t._v(" 加载器")]),a("p",[t._v("设置一个path变量  然后通过path来查找  这个可以不实现  看心情   CommonJs管不到。。\n再举个栗子")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_a_1533121025_305852556.png",alt:"a"}})]),a("p",[t._v("完成")]),a("h2",{attrs:{id:"node的模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node的模块","aria-hidden":"true"}},[t._v("#")]),t._v(" node的模块")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("node index.js\n")])]),a("p",[t._v("index.js 就是入口文件"),a("br"),t._v("\n入口之后 都是一个一个模块组成 大部分是CommonJs规范  还有一些"),a("code",[t._v(".node")]),t._v("的文件 这些就是C++模块文件\n有啥好处呢\n配合npm2.X版本 是嵌套类型能精准控制依赖版本\n3.0 扁平化依赖  为了控制体积\n对于后端和CLI 更适合npm2.。")]),a("h3",{attrs:{id:"寻找路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#寻找路径","aria-hidden":"true"}},[t._v("#")]),t._v(" 寻找路径")]),a("p",[t._v('之前说过  node中可以使用以 "." 以及 ".." 带头的相对路径\n在node在 大小写随便用其实也是可以的'),a("br"),t._v("\n比如 https://gitlab.renrenche.com/fe/swagger-axios")]),a("ol",[a("li",[t._v("Node.js 核心模块")]),a("li",[t._v("文件模块")]),a("li",[t._v("三方模块")]),a("li",[t._v("项目模块")])]),a("h4",{attrs:{id:"核心模块-https-github-com-nodejs-node-tree-v6-9-4-lib"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心模块-https-github-com-nodejs-node-tree-v6-9-4-lib","aria-hidden":"true"}},[t._v("#")]),t._v(" (核心模块)[https://github.com/nodejs/node/tree/v6.9.4/lib]")]),a("p",[t._v("迭代有点快  放了个老的LTS版本")]),a("p",[t._v("这些模块编译后会放到node的可执行文件中\n而且 每一个文件都有一个预留标志"),a("br"),t._v("\n自己写的  最好不要重名\n不然只会返回核心模块的")]),a("h4",{attrs:{id:"文件模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件模块","aria-hidden":"true"}},[t._v("#")]),t._v(" 文件模块")]),a("p",[t._v("通过路径的方式引入的模块")]),a("h5",{attrs:{id:"三方模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三方模块","aria-hidden":"true"}},[t._v("#")]),t._v(" 三方模块")]),a("p",[t._v("找到的是目录的话  会依次寻找  index.js  index.json index.node  然后返回")]),a("h5",{attrs:{id:"项目模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目模块","aria-hidden":"true"}},[t._v("#")]),t._v(" 项目模块")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('比如一个 JavaScript 文件路径是 /Users/biu/index.js，那么在 require("/Users/biu") 的时候，该 JavaScript 文件会被加载。\n')])]),a("p",[t._v("如果package.json 的main字段指向的是  biu.js  会直接找到biu.js  而不会例会index.js")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533122207_1535541421.png",alt:""}})]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('// a_program.js\n\nconst Biu = require("biu");\n// package.json 的部分源码\n')])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('{\n  ...,\n  "main": "biu.js",\n  ...\n}\n')])]),a("h5",{attrs:{id:"再说三方模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#再说三方模块","aria-hidden":"true"}},[t._v("#")]),t._v(" 再说三方模块")]),a("p",[t._v("传进去的标志 是"),a("code",[t._v("/")]),t._v(" ,"),a("code",[t._v("./")]),t._v(","),a("code",[t._v("../")]),t._v("这种 通常是依赖包的形式存在的"),a("br"),t._v("\nnode 不仅仅会在当前目录寻找")]),a("ol",[a("li",[t._v("当前文件目录的 node_modules 目录下；")]),a("li",[t._v("若 1 没有符合的模块，则去当前文件目录的父目录的 node_modules 下；")]),a("li",[t._v("若没有符合的模块，则再往上一层目录的 node_modules；")]),a("li",[t._v("若没有符合的模块，重复 3 直到寻找到符合的模块或者根目录为止。")])]),a("p",[t._v("其它的标识不是以 "),a("code",[t._v("/")]),t._v(" ,"),a("code",[t._v("./")]),t._v(","),a("code",[t._v("../")]),t._v("带头的模块被称为三方模块，这些模块通常以 Node.js 依赖包形式存在。")]),a("h5",{attrs:{id:"模块缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模块缓存","aria-hidden":"true"}},[t._v("#")]),t._v(" 模块缓存")]),a("p",[t._v("node会缓存第一次加载的代码 第二次的时候 会直接返回缓存")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('// dog.js\n\n"use strict";\n\nlet boom = "嘘，蛋花汤";\nboom += "在睡觉。OOO";\n\nmodule.exports = {\n  "OOO": boom\n};\n')])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('// entry.js\n\n"use strict";\n\nlet ლ_ಠ益ಠ_ლ = require("./dog");\n\nconsole.log(ლ_ಠ益ಠ_ლ);\n\nlet 蛋花汤 = require("./dog");\n\nconsole.log(蛋花汤);\n')])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$ node entry.js\n{ 'OOO': '嘘，蛋花汤在睡觉。OOO' }\n{ 'OOO': '嘘，蛋花汤在睡觉。OOO' }\n")])]),a("h3",{attrs:{id:"node包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node包","aria-hidden":"true"}},[t._v("#")]),t._v(" node包")]),a("h4",{attrs:{id:"包描述文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#包描述文件","aria-hidden":"true"}},[t._v("#")]),t._v(" 包描述文件")]),a("p",[t._v("package.json")]),a("h5",{attrs:{id:"必填"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#必填","aria-hidden":"true"}},[t._v("#")]),t._v(" 必填")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533123592_1533676748.png",alt:""}})]),a("h5",{attrs:{id:"选填"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选填","aria-hidden":"true"}},[t._v("#")]),t._v(" 选填")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533123608_258888695.png",alt:""}})]),a("p",[t._v("保留字段有：build，default，email，external，files，imports，maintainer，paths，platform，require，summary，test，using，downloads，uid，type。\n其他可以写 但是会被包管理器忽略")]),a("p",[t._v("node模块包描述引用的CommonJs的包描述")]),a("p",[t._v("来个栗子CommonJs\n"),a("img",{attrs:{src:"/images/nodeModels/_1533123722_677683093.png",alt:""}})]),a("p",[t._v("node包描述")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533123692_340428043.png",alt:""}})]),a("p",[t._v("具体可以看https://docs.npmjs.com/files/package.json")]),a("p",[t._v("npm2 是嵌套的  npm3是扁平的"),a("br"),t._v("\n举个栗子\n举个例子，我们的项目有一个依赖包 bar 的 1.0.0 版本依赖另一个包 foo 的 ^1.0.0 版本，而我们项目的另一个依赖包 baz 的 1.0.0 版本依赖了 foo 的 ^1.1.0 版本\nnpm2")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("└── node_modules\n    ├── bar\n    │   └── node_modules\n    │       └── foo\n    └── baz\n        └── node_modules\n            └── foo\n")])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('如果 bar 的开发者觉得 foo 中有一个函数无法满足自己的需求，那么也许它会有这么一段代码：\n\nconst foo = require("foo");\n\nconst old = foo.func;\nfoo.func = function() {\n    // do some hack\n    // 做一些注入式的代码，使其满足自己的要求\n    // 但这段代码可能会引起其它使用该包的依赖\n    // 造成破坏\n};\n')])]),a("p",[t._v("在npm2 中 是两份不同的缓存  不会有问题\nnpm3+  就不知道会造成什么后果了 扁平化  适合面向体积优化  带来危险不可预知")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("└── node_modules\n    ├── bar\n    └── foo\n    └── baz\n")])]),a("p",[t._v("依赖爆炸。 对于想要开发node的来说  是个灾难。。")]),a("h5",{attrs:{id:"循环引用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#循环引用","aria-hidden":"true"}},[t._v("#")]),t._v(" 循环引用")]),a("p",[t._v("假如一不小心，a 引用 b，b 又引用了 a 这种\na和b都加载完成了\n那是没什么问题的  因为加载的时候 都已经加载完成了\n如果没有加载完成 a没加载完  加载b  OK   这个时候b又去加载a  炸了。。\n如果只是单独一个函数"),a("br"),t._v("\n那就用到的时候再去加载")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('// a.js\nconst b = require("b");\n\n// 做一些事情...\n')])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('// b.js\nexports.test = function() {\n    const a = require("a");\n};\n')])]),a("h3",{attrs:{id:"cnpm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cnpm","aria-hidden":"true"}},[t._v("#")]),t._v(" cnpm")]),a("p",[t._v("和npm的工作原理不一样 会将包缓存到node_modules\\npminstall这个目录下 然后再以软连接的形式（windows上是快捷方式）链接到项目目录。\n这样会导致一个问题。所有的包都只有一份实体。\n因为缓存是根据路径缓存的。然后拿的路径是软连接。所以每次拿的缓存是单独的，")]),a("p",[t._v("cnpm4.2和4.3的区别和npm2与npm3项目目录很像。\n但是为了服务后端服务人员。是先按照npm2的方法存放一份包。然后再把相关依赖按照npm3的方法再放一份包。\n这样解决了前端开发人员和后端开发人员 对不同包管理器的依赖喜好")]),a("h2",{attrs:{id:"node-模块加载原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-模块加载原理","aria-hidden":"true"}},[t._v("#")]),t._v(" node 模块加载原理")]),a("p",[t._v("nodejs载入一个模块或者C++扩展是依赖require来加载的 （ES6的先不管）\n先说一下"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/src/node_main.cc",target:"_blank",rel:"noopener noreferrer"}},[t._v("nodejs的入口")])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// src/node_main.cc\nint main(int argc, char *argv[]) {\n  // Disable stdio buffering, it interacts poorly with printf()\n  // calls elsewhere in the program (e.g., any logging from V8.)\n  setvbuf(stdout, nullptr, _IONBF, 0);\n  setvbuf(stderr, nullptr, _IONBF, 0);\n  // 直接进入node命名空间，然后调用start函数\n  return node::Start(argc, argv);\n}\n")])]),a("p",[t._v("然后门去node里"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/src/node.cc#L3470",target:"_blank",rel:"noopener noreferrer"}},[t._v("看一下")])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("\n// Execute the lib/internal/bootstrap_node.js file which was included as a\n// static C string in node_natives.h by node_js2c.\n// 'internal_bootstrap_node_native' is the string containing that source code.\n// 进入之后启动bootstrap_node  进行初始化\nLocal<String> script_name = FIXED_ONE_BYTE_STRING(env->isolate(),\n                                                \"bootstrap_node.js\");\nLocal<Value> f_value = ExecuteString(env, MainSource(env), script_name);\n\n...\n\nLocal<Function> f = Local<Function>::Cast(f_value);\n\n...\n\nf->Call(Null(env->isolate()), 1, &arg);\n")])]),a("p",[t._v("bootstrap_node.js其实是一个大闭包的函数\n在上面那段代码会把process对象给注入进去"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/lib/internal/bootstrap_node.js",target:"_blank",rel:"noopener noreferrer"}})]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("(function(process) {\n...\n\n})\n")])]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533262790_1843766525.png",alt:""}}),t._v("\n大概的一个启动流程。。\n在node中其实是有四类模块")]),a("ul",[a("li",[t._v("C++核心")]),a("li",[t._v("node内置")]),a("li",[t._v("用户源码")]),a("li",[t._v("C++扩展")])]),a("p",[t._v("之前讲的时候C++核心 和 node内置 都是node和核心模块 用户源码和C++扩展都是属于文件模块")]),a("p",[t._v("node 是原生模块\n先介绍下Binding函数"),a("br"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/src/node.cc#L2609",target:"_blank",rel:"noopener noreferrer"}},[t._v("对应的是")])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("其中 Local<String> module = args[0]->ToString(env->isolate()); 和 node::Utf8Value module_v(env->isolate(), module); 两句代码意味着从参数中获得文件标识（或者也可以认为是文件名）的字符串并赋值给 module_v。\n")])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("在得到标识字符串之后，Node.js 将通过 node_module* mod = get_builtin_module(*module_v); 这段代码获取 C++ 核心模块，例如未经源码 lib 目录下的 JavaScript 文件封装的 file 模块。我们注意到这里获取核心模块用的是一个叫 get_builtin_module 函数，这个函数内部做的工作就是在一条叫 modlist_builtin 的 C++ 核心模块链表上进行对比文件标识，从而返回相应的模块。\n")])]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("追根溯源，这些 C++ 核心模块则是在 node_module_register 函数中被逐一注册进链表里面的。\n")])]),a("p",[a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/src/node.cc#L2378-L2405",target:"_blank",rel:"noopener noreferrer"}},[t._v("node_module_register")])]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extern")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"C"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node_module_register")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("node_module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" mp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" reinterpret_cast"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("node_module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nm_flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" NM_F_BUILTIN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    mp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nm_link "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" modlist_builtin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    modlist_builtin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("node_is_initialized"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// "Linked" modules are included as part of the node project.')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Like builtins they are registered *before* node::Init runs.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//“链接”模块作为节点项目的一部分包含在内。")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//与内置类似，它们在* node :: Init运行之前注册*。")]),t._v("\n    mp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nm_flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NM_F_LINKED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    mp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nm_link "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" modlist_linked"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    modlist_linked "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    modpending "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("node_module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_builtin_module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("node_module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" mp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" modlist_builtin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" mp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" nullptr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" mp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nm_link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strcmp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nm_modname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CHECK")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" nullptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("nm_flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" NM_F_BUILTIN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),a("p",[a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/src/node.h#L458-L484",target:"_blank",rel:"noopener noreferrer"}},[t._v("注册核心模块的宏")])]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(' NODE_MODULE_CONTEXT_AWARE_X(modname, regfunc, priv, flags)    \\\n  extern "C" {                                                        \\\n    static node::node_module _module =                                \\\n    {                                                                 \\\n      NODE_MODULE_VERSION,                                            \\\n      flags,                                                          \\\n      NULL,                                                           \\\n      __FILE__,                                                       \\\n      NULL,                                                           \\\n      (node::addon_context_register_func) (regfunc),                  \\\n      NODE_STRINGIFY(modname),                                        \\\n      priv,                                                           \\\n      NULL                                                            \\\n    };                                                                \\\n    NODE_C_CTOR(_register_ ## modname) {                              \\\n      node_module_register(&_module);                                 \\\n    }                                                                 \\\n  }')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" NODE_MODULE(modname, regfunc)                                 \\\n  NODE_MODULE_X(modname, regfunc, NULL, 0)")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" NODE_MODULE_CONTEXT_AWARE(modname, regfunc)                   \\\n  NODE_MODULE_CONTEXT_AWARE_X(modname, regfunc, NULL, 0)")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" NODE_MODULE_CONTEXT_AWARE_BUILTIN(modname, regfunc)           \\\n  NODE_MODULE_CONTEXT_AWARE_X(modname, regfunc, NULL, NM_F_BUILTIN)   \\\n")])])]),a("p",[t._v("关键的宏："),a("code",[t._v("NODE_MODULE_CONTEXT_AWARE_BUILTIN")]),t._v(" 注册进核心模块\n"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/src/node_file.cc#L1511",target:"_blank",rel:"noopener noreferrer"}},[t._v("node_file.cc")]),t._v("\n// node_file.cc 最后一行")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NODE_MODULE_CONTEXT_AWARE_BUILTIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("InitFs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),a("p",[t._v("也就是说，基本上在每个 C++ 核心模块的源码末尾都有有一个宏调用将该模块注册进 C++ 核心模块的链表当中去，以供 process.binding 进行获取。")]),a("p",[t._v("有兴趣的  可以研究下  没兴趣的可以略过")]),a("h3",{attrs:{id:"nodejs-内置模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodejs-内置模块","aria-hidden":"true"}},[t._v("#")]),t._v(" nodejs 内置模块")]),a("p",[t._v("FS HTTP 等、基本等同于API  是放在lib目录下的那些  基本是对核心模块的一个高级封装\n如 ·"),a("code",[t._v("lib/crypto.js")]),t._v("中就有一段 "),a("code",[t._v('const binding = process.binding("crypto");')]),t._v("这样的代码，它的很多内容都是基于 C++ 核心模块中的 crypto 进行实现的。\njs文件也是编译到可执行文件的")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533269278_2142443112.png",alt:""}})]),a("p",[t._v("内置模块的相关处理"),a("br"),t._v("\n如果是native_module  那就返回那个类\n不然就进入 compile  进行编译"),a("br"),t._v("\n看到第一行 获取这个模块的源码\n直接返回_source[id]\n这个其实是直接返回bing")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strcmp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("module_v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"natives"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("New")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isolate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DefineJavaScript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  cache"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),a("p",[t._v("然后再看下"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/src/node_javascript.cc#L23-L36",target:"_blank",rel:"noopener noreferrer"}},[t._v("DefineJavaScript")])]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DefineJavaScript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Environment"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Object"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  HandleScope "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("scope")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isolate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("auto")]),t._v(" native "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" natives"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("native"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("source "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" internal_bootstrap_node_native"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      Local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" String"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewFromUtf8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isolate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" native"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      Local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" source "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n          String"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewFromUtf8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n              env"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isolate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reinterpret_cast"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("native"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n              NewStringType"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),t._v("kNormal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" native"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("source_len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ToLocalChecked")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),a("p",[t._v("大概返回结果就是这样的")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('{ fs: "fs 的源码", http: "http 的源码" }\n')])]),a("p",[t._v("native这个变量并没有在这里"),a("br"),t._v("\n可以看一下node-gyp的配置文件   然后有个node_js2c  在这一步里面做的事情就是用 Python 去调用一个叫 tools/js2c.py 的文件。而这个 js2c.py 就是问题的关键所在了\n"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/tools/js2c.py",target:"_blank",rel:"noopener noreferrer"}},[t._v("js2c")]),t._v("\n这个文件会生成 src/node_natives.h 这个头文件 然后就存在了\n"),a("img",{attrs:{src:"/images/nodeModels/_1533279346_1183074135.png",alt:""}})]),a("p",[t._v("大概是这样\n把传说中编译进 Node.js 二进制文件的 JavaScript 代码的神秘面纱揭开以后，我们现在回到 NativeModule.compile 函数中来。它会在刚获取到的内置模块 JavaScript 源码字符串前后用 (function (exports, require, module, __filename, __dirname) { 和 }); 进行包裹，形成一段闭包代码，然后将其放入 vm6 （安全沙箱）中运行，并传入事先准备好的 module 和 exports 对象供其导出。")]),a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// a.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" foo"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 编译后")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("exports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" require"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __dirname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" foo"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// compile 执行")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this 就是 NativeModule 类实例化出来的一个对象")]),t._v("\nfn "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" 刚才编译后得到的闭包函数"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("this"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports， NativeModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("require"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" this"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" this"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("p",[t._v("大概的一个包的require的过程")]),a("div",{staticClass:"tip custom-block"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),a("p",[t._v("这里的Module是NativeModule 我们自己写的是另一个module 只不过共用了一个闭包的源码。")])]),a("p",[t._v("举个例子  写个a.js\n然后console.log(Module)")]),a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("Module "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  exports"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  parent"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  filename"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/private/tmp/temp/a.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  loaded"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  children"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  paths"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/private/tmp/temp/node_modules'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/private/tmp/node_modules'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/private/node_modules'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/node_modules'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),a("p",[t._v("可以看出来 exports 只是其中一小部分\n但是这部分是我们用的最多的")]),a("h3",{attrs:{id:"用户源码模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户源码模块","aria-hidden":"true"}},[t._v("#")]),t._v(" 用户源码模块")]),a("p",[t._v("非node源码模块的js模块\n运行时 按照需求  加载进来的\n每个模块也会被加上这个闭包的头尾\n具体的实现可以看"),a("a",{attrs:{href:"https://github.com/nodejs/node/blob/v6.9.4/lib/module.js#L37",target:"_blank",rel:"noopener noreferrer"}},[t._v("module")]),t._v("\n我们平时用的require就是这个模块中的require函数\nmodule类的实例对象  就是用户源码模块的真正本体。在VM运行的结果 就是核心\n我们平时写的module.exports就是这个的一个实例对象。\nmodule就是这个类 实例化之后的对象\n当我们写 "),a("code",[t._v("module.exports = foo")]),t._v(" 的时候就是给这个 module 对象的 exports 变量重新赋了个值。")]),a("p",[t._v("看下require函数吧 直接去调用module._load")]),a("p",[t._v("然后表示不是入口模块\n"),a("img",{attrs:{src:"/images/nodeModels/_1533280856_375899372.png",alt:""}}),a("img",{attrs:{src:"/images/nodeModels/_1533280928_1991339377.png",alt:""}})]),a("p",[t._v("整体流程是\n"),a("img",{attrs:{src:"/images/nodeModels/_1533280961_2055754391.png",alt:""}}),t._v("\n加载模块我们省略了 因为他是调用 trymoduleload来执行的  其实就是loan函数加了错误处理\n根据不同文件名选择不同加载方式")]),a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("load "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  this"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  this"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("paths "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_nodeModulePaths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dirname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  var extension "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("extname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("extension"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" extension "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("extension"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("this"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  this"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loaded "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" true"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("p",[t._v("说一下JS的吧")]),a("p",[t._v('Module._extensions[".js"] 这种规则做的事情分两步：')]),a("ol",[a("li",[t._v("同步读取源码（filename）的内容，使用 fs.readFileSync；")]),a("li",[t._v("调用 module._compile() 函数编译源码并执行。")])]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533281181_199652954.png",alt:""}})]),a("p",[t._v("这个函数也是生成闭包代码 然后执行")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533281211_1197741264.png",alt:""}})]),a("p",[t._v("一个模块的源码 经过编译之后 就形成了 携带"),a("code",[t._v("expotr")]),t._v("、"),a("code",[t._v("require")]),t._v(","),a("code",[t._v("filename")]),t._v(","),a("code",[t._v("dirname")]),t._v("的一个函数了  这就是我们平时能直接用这些东西的原因了")]),a("p",[t._v("node加载  window类似dll  linux 类似动态链接库")]),a("p",[a("img",{attrs:{src:"/images/nodeModels/_1533283596_2073200717.png",alt:""}})]),a("p",[t._v("最后我再给大家一个小技巧，改造 "),a("code",[t._v("require()")]),t._v(" 函数的规则，比如大家的项目目录下有个 "),a("code",[t._v("lib/test/a.js")]),t._v(" 文件，然后可以让大家在项目的任意文件中直接通过 "),a("code",[t._v('require("lib/test/a")')]),t._v(" 就能获取这个模块，而不用去自行计算相对路径值绕来绕去")])])}],!1,null,null,null);s.default=e.exports}}]);